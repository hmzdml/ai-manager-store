// ===========================================
// AI Store Manager - Database Schema
// ===========================================
// This file defines all database tables for the AI-powered Shopify management system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== CORE SYSTEM ====================

// System configuration and feature flags
model Config {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  category  String   // "shopify", "ai", "ads", "social", "seo"
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@index([category])
}

// Master automation control
model AutomationControl {
  id                    String   @id @default(cuid())
  masterEnabled         Boolean  @default(true)
  shopifySync           Boolean  @default(true)
  aiCategorization      Boolean  @default(true)
  aiContentImprovement  Boolean  @default(true)
  googleMerchant        Boolean  @default(true)
  googleAds             Boolean  @default(false)
  metaAds               Boolean  @default(false)
  tiktokAds             Boolean  @default(false)
  microsoftAds          Boolean  @default(false)
  seoAutomation         Boolean  @default(true)
  socialMediaPosting    Boolean  @default(true)
  pausedUntil           DateTime?
  updatedAt             DateTime @updatedAt
  createdAt             DateTime @default(now())
}

// Activity logs for all automation actions
model ActivityLog {
  id          String   @id @default(cuid())
  module      String   // "shopify", "ai", "ads", "social", "seo", "gmc"
  action      String   // "sync", "categorize", "improve_content", "create_campaign", etc.
  status      String   // "success", "error", "warning"
  message     String   @db.Text
  metadata    Json?    // Additional structured data
  duration    Int?     // Milliseconds
  createdAt   DateTime @default(now())

  @@index([module, createdAt])
  @@index([status, createdAt])
}

// ==================== SHOPIFY DATA ====================

// Products synced from Shopify
model Product {
  id                String              @id // Shopify product ID
  title             String
  description       String?             @db.Text
  vendor            String?
  productType       String?
  handle            String              @unique
  status            String              // "active", "draft", "archived"
  tags              String[]
  price             Float?
  compareAtPrice    Float?
  images            Json[]              // Array of image URLs and metadata
  variants          Json[]              // Product variants data
  metafields        Json?
  shopifyCreatedAt  DateTime
  shopifyUpdatedAt  DateTime
  lastSyncedAt      DateTime            @default(now())
  
  // AI Management
  aiManaged         Boolean             @default(true)
  aiLocked          Boolean             @default(false)  // Lock to prevent AI changes
  
  // Relations
  categorization    ProductCategory?
  contentHistory    ProductContentHistory[]
  gmcStatus         GoogleMerchantProduct?
  
  @@index([status])
  @@index([vendor])
  @@index([aiManaged, aiLocked])
}

// AI-determined product categorization
model ProductCategory {
  id              String   @id @default(cuid())
  productId       String   @unique
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  mainCategory    String
  subCategory     String?
  aiTags          String[] // AI-generated tags
  confidence      Float    // 0-1 confidence score
  
  // Google Shopping category
  googleCategory  String?
  
  reasoning       String?  @db.Text // AI explanation
  
  categorizedAt   DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([mainCategory, subCategory])
}

// History of AI content improvements
model ProductContentHistory {
  id              String   @id @default(cuid())
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  field           String   // "title", "description", "meta_title", "meta_description"
  originalValue   String   @db.Text
  improvedValue   String   @db.Text
  applied         Boolean  @default(false)
  appliedAt       DateTime?
  
  aiModel         String
  aiReasoning     String?  @db.Text
  
  createdAt       DateTime @default(now())
  
  @@index([productId, field])
  @@index([applied])
}

// Shopify collections
model Collection {
  id                String   @id // Shopify collection ID
  title             String
  handle            String   @unique
  description       String?  @db.Text
  sortOrder         String?
  image             Json?
  productsCount     Int      @default(0)
  
  aiManaged         Boolean  @default(false)
  
  shopifyCreatedAt  DateTime
  shopifyUpdatedAt  DateTime
  lastSyncedAt      DateTime @default(now())
  
  @@index([aiManaged])
}

// ==================== GOOGLE MERCHANT CENTER ====================

model GoogleMerchantProduct {
  id              String   @id @default(cuid())
  productId       String   @unique
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  status          String   // "approved", "disapproved", "warning"
  issues          Json[]   // Array of issue objects
  
  // Last fix attempt
  lastFixAttempt  DateTime?
  fixApplied      Boolean  @default(false)
  fixSuggestion   String?  @db.Text
  
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())
  
  @@index([status])
}

// ==================== ADVERTISING PLATFORMS ====================

// Ad campaigns across all platforms
model AdCampaign {
  id              String   @id @default(cuid())
  platform        String   // "google", "meta", "tiktok", "microsoft"
  platformId      String?  // External campaign ID
  
  name            String
  objective       String   // "traffic", "conversions", "awareness"
  status          String   // "active", "paused", "draft"
  
  // Targeting
  targetLocations String[]
  targetAudience  Json?
  
  // Budget
  dailyBudget     Float
  totalBudget     Float?
  spent           Float    @default(0)
  
  // Performance (synced from platform)
  impressions     Int      @default(0)
  clicks          Int      @default(0)
  conversions     Int      @default(0)
  revenue         Float    @default(0)
  
  // AI Management
  aiGenerated     Boolean  @default(false)
  autoOptimize    Boolean  @default(true)
  requiresApproval Boolean @default(true)
  approved        Boolean  @default(false)
  approvedAt      DateTime?
  
  // Relations
  adSets          AdSet[]
  
  startDate       DateTime?
  endDate         DateTime?
  lastSyncedAt    DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([platform, status])
  @@index([aiGenerated, approved])
}

// Ad sets / ad groups
model AdSet {
  id              String     @id @default(cuid())
  campaignId      String
  campaign        AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  platform        String
  platformId      String?
  name            String
  status          String
  
  // Targeting details
  targeting       Json?
  
  // Budget allocation
  budget          Float?
  
  // Relations
  ads             Ad[]
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@index([campaignId])
}

// Individual ads
model Ad {
  id              String   @id @default(cuid())
  adSetId         String
  adSet           AdSet    @relation(fields: [adSetId], references: [id], onDelete: Cascade)
  
  platform        String
  platformId      String?
  
  headline        String
  primaryText     String   @db.Text
  description     String?  @db.Text
  callToAction    String?
  
  // Creative assets
  imageUrl        String?
  videoUrl        String?
  
  // Performance
  impressions     Int      @default(0)
  clicks          Int      @default(0)
  conversions     Int      @default(0)
  
  status          String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([adSetId])
}

// ==================== SEO MANAGEMENT ====================

// SEO audit results
model SeoAudit {
  id              String   @id @default(cuid())
  url             String
  type            String   // "product", "collection", "page", "blog_post"
  resourceId      String?  // Product ID, collection ID, etc.
  
  // Issues found
  missingTitle    Boolean  @default(false)
  missingMetaDesc Boolean  @default(false)
  duplicateTitle  Boolean  @default(false)
  thinContent     Boolean  @default(false)
  brokenLinks     Int      @default(0)
  
  // AI suggestions
  suggestedTitle  String?
  suggestedMetaDesc String? @db.Text
  suggestedImprovements Json?
  
  score           Int      // 0-100 SEO score
  
  auditedAt       DateTime @default(now())
  fixed           Boolean  @default(false)
  fixedAt         DateTime?
  
  @@index([type, fixed])
  @@index([score])
}

// Blog posts for content marketing
model BlogPost {
  id              String   @id @default(cuid())
  shopifyId       String?  @unique
  
  title           String
  slug            String   @unique
  content         String   @db.Text
  excerpt         String?  @db.Text
  
  metaTitle       String?
  metaDescription String?  @db.Text
  
  tags            String[]
  featuredImage   String?
  
  status          String   @default("draft") // "draft", "published", "scheduled"
  
  aiGenerated     Boolean  @default(false)
  aiPrompt        String?  @db.Text
  
  publishedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([status])
  @@index([aiGenerated])
}

// ==================== SOCIAL MEDIA ====================

// Social media posts
model SocialPost {
  id              String   @id @default(cuid())
  platform        String   // "instagram", "facebook", "tiktok"
  platformPostId  String?  // ID after posting
  
  caption         String   @db.Text
  hashtags        String[]
  
  // Content
  imageUrl        String?
  videoUrl        String?
  productLinks    String[] // Related product IDs
  
  status          String   @default("scheduled") // "scheduled", "posted", "failed", "draft"
  
  scheduledFor    DateTime
  postedAt        DateTime?
  
  // Performance
  likes           Int      @default(0)
  comments        Int      @default(0)
  shares          Int      @default(0)
  
  // AI Generation
  aiGenerated     Boolean  @default(false)
  aiPrompt        String?  @db.Text
  
  error           String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([platform, status])
  @@index([scheduledFor])
}

// Social media content calendar
model ContentCalendar {
  id              String   @id @default(cuid())
  platform        String
  
  // Posting schedule
  frequency       String   // "daily", "3x_week", "weekly"
  preferredTimes  String[] // ["09:00", "15:00"]
  
  // Content themes
  themes          String[] // ["product_showcase", "tips", "behind_scenes", "ugc"]
  
  active          Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([platform])
}

// ==================== AI USAGE TRACKING ====================

// Track AI API usage and costs
model AiUsage {
  id              String   @id @default(cuid())
  
  taskType        String   // "categorize", "improve_content", "generate_ad", "fix_gmc", etc.
  model           String   // "gpt-4-turbo-preview", etc.
  
  promptTokens    Int
  completionTokens Int
  totalTokens     Int
  
  estimatedCost   Float    // USD
  
  success         Boolean
  errorMessage    String?  @db.Text
  
  createdAt       DateTime @default(now())
  
  @@index([taskType, createdAt])
  @@index([createdAt])
}

// Daily AI usage summary
model AiUsageSummary {
  id              String   @id @default(cuid())
  date            DateTime @unique @db.Date
  
  totalTokens     Int      @default(0)
  totalCost       Float    @default(0)
  totalRequests   Int      @default(0)
  
  byTaskType      Json     // Breakdown by task type
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([date])
}
